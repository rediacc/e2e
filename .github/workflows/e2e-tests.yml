name: E2E Tests

run-name: "${{ github.event.inputs.run-name || 'E2E Test Run' }}"

on:
  workflow_dispatch:
    inputs:
      run-name:
        description: 'Custom name for this test run'
        required: false
        default: 'E2E Test Run'
        type: string
      duration:
        description: 'Duration to keep Elite environment running (minutes)'
        required: false
        default: '30'
        type: choice
        options:
          - '5'
          - '10'
          - '15'
          - '30'
          - '45'
          - '60'
          - '90'
          - '120'
          - '180'
          - '240'
          - '300'
      version:
        description: 'Elite version to test against'
        required: false
        default: 'latest'
        type: string
      enable-vms:
        description: 'Enable VM provisioning'
        required: false
        default: true
        type: boolean
      vm-provider:
        description: 'VM infrastructure provider'
        required: false
        default: 'kvm'
        type: choice
        options:
          - 'kvm'
          - 'linode'
          - 'vultr'
      vm-configuration:
        description: 'VM cluster configuration'
        required: false
        default: 'Standard'
        type: choice
        options:
          - 'Minimal'
          - 'Basic'
          - 'Standard'
          - 'Full'
      vm-os-image:
        description: 'VM OS image'
        required: false
        default: 'rediacc-ubuntu-24.04'
        type: choice
        options:
          - 'ubuntu-24.04'
          - 'debian-12'
          - 'debian-11'
          - 'fedora-43'
          - 'fedora-42'
          - 'oracle-linux-9'
          - 'oracle-linux-8'
          - 'opensuse-15.6'
          - 'opensuse-15.5'
          - 'rocky-9'
          - 'centos-stream-10'
          - 'rediacc-ubuntu-24.04'
          - 'rediacc-debian-12'
          - 'rediacc-debian-11'
          - 'rediacc-fedora-43'
          - 'rediacc-oracle-linux-9'
          - 'rediacc-opensuse-15.5'
          - 'rediacc-centos-stream-10'
      enable-debug:
        description: 'Enable tmate SSH debugging session'
        required: false
        default: false
        type: boolean
      skip-machine-registration:
        description: 'Skip automatic machine registration'
        required: false
        default: false
        type: boolean
      ci-mode:
        description: 'Enable CI mode (bypasses email and captcha validation)'
        required: false
        default: true
        type: boolean
      browser:
        description: 'Browser to run tests in'
        required: false
        default: 'chromium'
        type: choice
        options:
          - 'chromium'
          - 'firefox'
          - 'webkit'
          - 'all'

  pull_request:
    branches:
      - main

  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      DEFAULT_DURATION: '30'
      DEFAULT_VERSION: 'latest'
      DEFAULT_ENABLE_VMS: 'true'
      DEFAULT_VM_PROVIDER: 'kvm'
      DEFAULT_VM_CONFIGURATION: 'Standard'
      DEFAULT_VM_OS_IMAGE: 'rediacc-ubuntu-24.04'
      DEFAULT_ENABLE_DEBUG: 'false'
      DEFAULT_SKIP_MACHINE_REG: 'false'
      DEFAULT_CI_MODE: 'true'
      DEFAULT_BROWSER: 'chromium'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}

      - name: Trigger Elite Environment
        id: trigger
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Triggering Elite environment..."

          # Set parameters
          RUN_NAME="${{ github.event.inputs.run-name || 'E2E Test Run' }}"
          DURATION="${{ github.event.inputs.duration || env.DEFAULT_DURATION }}"
          VERSION="${{ github.event.inputs.version || env.DEFAULT_VERSION }}"
          ENABLE_VMS="${{ github.event.inputs.enable-vms || env.DEFAULT_ENABLE_VMS }}"
          VM_PROVIDER="${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}"
          VM_CONFIG="${{ github.event.inputs.vm-configuration || env.DEFAULT_VM_CONFIGURATION }}"
          ENABLE_DEBUG="${{ github.event.inputs.enable-debug || env.DEFAULT_ENABLE_DEBUG }}"
          VM_OS_IMAGE="${{ github.event.inputs.vm-os-image || env.DEFAULT_VM_OS_IMAGE }}"
          SKIP_MACHINE_REG="${{ github.event.inputs.skip-machine-registration || env.DEFAULT_SKIP_MACHINE_REG }}"
          CI_MODE="${{ github.event.inputs.ci-mode || env.DEFAULT_CI_MODE }}"

          # Trigger environment
          ./go trigger "$RUN_NAME" "$DURATION" "$VERSION" "$ENABLE_VMS" "$VM_PROVIDER" "$VM_CONFIG" "$ENABLE_DEBUG" "$VM_OS_IMAGE" "$SKIP_MACHINE_REG" "$CI_MODE"

          # Extract tunnel URL for reporting
          if [ -f ".deployment-info.json" ]; then
            TUNNEL_URL=$(jq -r '.access.tunnel_url' .deployment-info.json)
            echo "tunnel-url=$TUNNEL_URL" >> $GITHUB_OUTPUT
            echo "Elite environment ready at: $TUNNEL_URL"
          fi

      - name: Display Test Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ TEST CONFIGURATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Base URL: ${{ steps.trigger.outputs.tunnel-url }}"
          echo "ğŸ–¥ï¸  Browser: ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"
          echo "ğŸ“¦ Version: ${{ github.event.inputs.version || env.DEFAULT_VERSION }}"
          echo "âš™ï¸  VM Config: ${{ github.event.inputs.vm-configuration || env.DEFAULT_VM_CONFIGURATION }}"
          echo "ğŸ–¥ï¸  VM Provider: ${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}"
          echo "ğŸ’¿ VM OS: ${{ github.event.inputs.vm-os-image || env.DEFAULT_VM_OS_IMAGE }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Run Playwright Tests
        id: tests
        run: |
          BROWSER="${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"

          if [ "$BROWSER" = "all" ]; then
            npx playwright test
          else
            npx playwright test --project="$BROWSER"
          fi
        env:
          CI: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-${{ github.run_id }}
          path: test-results/
          retention-days: 7

      - name: Cleanup Elite Environment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Cleaning up Elite environment..."
          ./go cleanup || true

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ TEST SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ”— Test run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“Š Report artifact: playwright-report-${{ github.run_id }}"
          echo "â±ï¸  Completed at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
