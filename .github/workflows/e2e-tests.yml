name: E2E Tests

run-name: "${{ github.event.inputs.run-name || format('E2E {0} @{1}', github.event_name == 'pull_request' && format('PR#{0}', github.event.pull_request.number) || github.event_name, github.sha) }}"

on:
  # Scheduled runs every 8 hours (00:00, 08:00, 16:00 UTC)
  schedule:
    - cron: '0 0,8,16 * * *'

  workflow_dispatch:
    inputs:
      run-name:
        description: 'Custom name for this test run'
        required: false
        default: ''
        type: string
      source-repo:
        description: 'Source repository that triggered this run (e.g., org/monorepo)'
        required: false
        default: ''
        type: string
      source-commit:
        description: 'Commit SHA from source repository'
        required: false
        default: ''
        type: string
      version:
        description: 'Elite version to test against'
        required: false
        default: 'latest'
        type: string
      browser:
        description: 'Browser to run tests in'
        required: false
        default: 'chromium'
        type: choice
        options:
          - 'chromium'
          - 'firefox'
          - 'webkit'
          - 'all'
      enable-vms:
        description: 'Enable VM provisioning'
        required: false
        default: true
        type: boolean
      vm-provider:
        description: 'VM infrastructure provider'
        required: false
        default: 'kvm'
        type: choice
        options:
          - 'kvm'
          - 'linode'
          - 'vultr'
      vm-configuration:
        description: 'VM cluster configuration'
        required: false
        default: 'Standard'
        type: choice
        options:
          - 'Minimal'
          - 'Basic'
          - 'Standard'
          - 'Full'
      vm-os-image:
        description: 'VM OS image'
        required: false
        default: 'rediacc-ubuntu-24.04'
        type: choice
        options:
          - 'ubuntu-24.04'
          - 'debian-12'
          - 'rediacc-ubuntu-24.04'
          - 'rediacc-debian-12'

  push:
    branches:
      - main

  pull_request:
    branches:
      - main

# Cancel in-progress runs when a new run is triggered for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  DEFAULT_VERSION: 'latest'
  DEFAULT_BROWSER: 'chromium'
  DEFAULT_ENABLE_VMS: 'true'
  DEFAULT_VM_PROVIDER: 'kvm'
  DEFAULT_VM_CONFIGURATION: 'Standard'
  DEFAULT_VM_OS_IMAGE: 'rediacc-ubuntu-24.04'

jobs:
  # Job 1: Setup E2E environment (runs in parallel, caches dependencies)
  e2e-setup:
    name: Setup E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Display Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ E2E TEST CONFIGURATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Run Details:"
          echo "   â€¢ Run Name: ${{ github.event.inputs.run-name || 'E2E Test Run' }}"
          echo "   â€¢ Trigger: ${{ github.event_name }}"
          echo "   â€¢ Run ID: ${{ github.run_id }}"
          if [ -n "${{ github.event.inputs.source-repo }}" ]; then
            echo ""
            echo "ğŸ”— Source (Cross-Repo Trigger):"
            echo "   â€¢ Repository: ${{ github.event.inputs.source-repo }}"
            echo "   â€¢ Commit: ${{ github.event.inputs.source-commit }}"
            echo "   â€¢ Commit URL: https://github.com/${{ github.event.inputs.source-repo }}/commit/${{ github.event.inputs.source-commit }}"
          fi
          echo ""
          echo "âš™ï¸  Settings:"
          echo "   â€¢ Version: ${{ github.event.inputs.version || env.DEFAULT_VERSION }}"
          echo "   â€¢ Browser: ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"
          echo "   â€¢ Enable VMs: ${{ github.event.inputs.enable-vms || env.DEFAULT_ENABLE_VMS }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout E2E Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}

      - name: Cache E2E Setup
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: e2e-setup-${{ github.run_id }}

  # Job 2: Run E2E Tests with VM Provisioning (all on same runner!)
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [e2e-setup]

    steps:
      - name: Display Test Configuration
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  E2E TEST CONFIGURATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ VM Settings:"
          echo "   â€¢ Enable VMs: ${{ github.event.inputs.enable-vms || env.DEFAULT_ENABLE_VMS }}"
          echo "   â€¢ Provider: ${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}"
          echo "   â€¢ Configuration: ${{ github.event.inputs.vm-configuration || env.DEFAULT_VM_CONFIGURATION }}"
          echo "   â€¢ OS Image: ${{ github.event.inputs.vm-os-image || env.DEFAULT_VM_OS_IMAGE }}"
          echo ""
          echo "ğŸ“‹ Test Settings:"
          echo "   â€¢ Version: ${{ github.event.inputs.version || env.DEFAULT_VERSION }}"
          echo "   â€¢ Browser: ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Checkout E2E Repository
        uses: actions/checkout@v4

      - name: Checkout Elite Repository
        uses: actions/checkout@v4
        with:
          repository: rediacc/elite
          path: elite
          token: ${{ secrets.GH_PAT }}

      - name: Validate Elite Version
        working-directory: elite
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: ./action/ci-validate-version.sh "${{ github.event.inputs.version || env.DEFAULT_VERSION }}"

      - name: Pull Docker Images
        working-directory: elite
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          TAG: ${{ env.TAG }}
        run: ./action/ci-pull-images.sh

      - name: Start Elite Services
        id: services
        uses: ./elite/action
        with:
          keep-alive: true
          ci-mode: true
        env:
          TAG: ${{ env.TAG }}
          SKIP_MACHINE_REGISTRATION: ${{ github.event.inputs.enable-vms != 'false' && 'true' || 'false' }}

      # VM Provisioning steps (only if VMs enabled)
      - name: Extract SSH Keys
        if: github.event.inputs.enable-vms != 'false'
        working-directory: elite
        env:
          TAG: ${{ env.TAG }}
        run: |
          echo "Extracting SSH keys from middleware..."

          timeout 60 bash -c 'until ./go health; do sleep 2; done'

          # Install rediacc CLI from local /pypi/ (embedded in web image)
          # Note: rediacc is NOT published to public PyPI - must use embedded package
          LOCAL_PYPI="http://localhost/pypi/"
          TAG_VERSION="${TAG:-latest}"

          # Check if CLI packages are embedded in the web image
          echo "Checking for embedded CLI packages..."
          if ! curl -sf "http://localhost/cli-packages.json" > /dev/null 2>&1; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ERROR: CLI packages not embedded in web image"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "The web Docker image does not have CLI packages embedded."
            echo "Rebuild the images with:"
            echo "  ./go build pypi    # Build Python CLI package"
            echo "  ./go build prod    # Build Docker images (embeds CLI packages)"
            echo ""
            exit 1
          fi

          if [ "$TAG_VERSION" = "latest" ]; then
            if pip install --quiet --find-links "$LOCAL_PYPI" --trusted-host localhost rediacc 2>/dev/null; then
              echo "âœ“ Installed rediacc from local /pypi/"
            else
              echo "ERROR: Failed to install rediacc from local /pypi/"
              exit 1
            fi
          else
            if pip install --quiet --find-links "$LOCAL_PYPI" --trusted-host localhost "rediacc==$TAG_VERSION" 2>/dev/null; then
              echo "âœ“ Installed rediacc $TAG_VERSION from local /pypi/"
            elif pip install --quiet --find-links "$LOCAL_PYPI" --trusted-host localhost rediacc 2>/dev/null; then
              echo "âš  Version $TAG_VERSION not found, installed latest from local /pypi/"
            else
              echo "ERROR: Failed to install rediacc from local /pypi/"
              exit 1
            fi
          fi

          source action/ci-env.sh
          export SYSTEM_API_URL="http://localhost/api"

          rediacc auth login \
            --endpoint "$SYSTEM_API_URL" \
            --email "$SYSTEM_ADMIN_EMAIL" \
            --password "$SYSTEM_ADMIN_PASSWORD"

          # Fetch team list from API
          TEAM_LIST_OUTPUT=$(rediacc GetOrganizationTeams --output json)

          # Get vault content for the target team
          VAULT_CONTENT=$(echo "$TEAM_LIST_OUTPUT" | \
            jq -r --arg team "$SYSTEM_DEFAULT_TEAM_NAME" \
            '.data.result[] | select(.teamName == $team or .TeamName == $team) | (.vaultContent // empty)')

          if [ -z "$VAULT_CONTENT" ] || [ "$VAULT_CONTENT" = "null" ]; then
            echo "ERROR: Team vault is empty or not accessible for team '$SYSTEM_DEFAULT_TEAM_NAME'"
            echo "Available teams:"
            echo "$TEAM_LIST_OUTPUT" | jq -r '.data.result[].teamName // .data.result[].TeamName'
            exit 1
          fi

          # Parse vault content (handle both string and object formats)
          TEAM_VAULT=$(echo "$VAULT_CONTENT" | jq 'if type == "string" then fromjson else . end' 2>/dev/null)

          if [ -z "$TEAM_VAULT" ] || [ "$TEAM_VAULT" = "null" ] || [ "$TEAM_VAULT" = "{}" ]; then
            echo "ERROR: Failed to parse team vault content"
            exit 1
          fi

          # Extract SSH keys with validation
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          SSH_PRIVATE_KEY=$(echo "$TEAM_VAULT" | jq -r '.SSH_PRIVATE_KEY // empty')
          SSH_PUBLIC_KEY=$(echo "$TEAM_VAULT" | jq -r '.SSH_PUBLIC_KEY // empty')

          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "ERROR: SSH_PRIVATE_KEY not found in team vault"
            echo "Vault keys: $(echo "$TEAM_VAULT" | jq -r 'keys | join(", ")')"
            exit 1
          fi

          if [ -z "$SSH_PUBLIC_KEY" ]; then
            echo "ERROR: SSH_PUBLIC_KEY not found in team vault"
            echo "Vault keys: $(echo "$TEAM_VAULT" | jq -r 'keys | join(", ")')"
            exit 1
          fi

          # Write SSH keys (plain text PEM/public key)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          echo "$SSH_PUBLIC_KEY" > ~/.ssh/id_rsa.pub

          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

          # Validate the generated files
          if [ ! -s ~/.ssh/id_rsa ] || [ ! -s ~/.ssh/id_rsa.pub ]; then
            echo "ERROR: SSH key files are empty after decoding"
            exit 1
          fi

          echo "âœ“ SSH keys extracted"
          rediacc auth logout

      - name: Provision VMs
        id: vms
        if: github.event.inputs.enable-vms != 'false'
        uses: rediacc/ops/.github/actions/setup-vms@main
        with:
          provider: ${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}
          configuration: ${{ github.event.inputs.vm-configuration || env.DEFAULT_VM_CONFIGURATION }}
          duration: '60'
          api-token: ${{ github.event.inputs.vm-provider == 'linode' && secrets.LINODE_API_TOKEN || github.event.inputs.vm-provider == 'vultr' && secrets.VULTR_API_TOKEN || '' }}
        env:
          VM_OS_IMAGE: ${{ github.event.inputs.vm-os-image || env.DEFAULT_VM_OS_IMAGE }}
          TAG: ${{ env.TAG }}
          DOCKER_BRIDGE_IMAGE: ghcr.io/rediacc/elite/bridge:${{ env.TAG }}
          DOCKER_BRIDGE_NETWORK_MODE: host
          DOCKER_BRIDGE_API_URL: http://localhost
          SYSTEM_API_URL: http://localhost/api
          SKIP_MACHINE_REGISTRATION: 'true'
          CI_MODE: 'true'

      - name: Register Worker Machines
        if: github.event.inputs.enable-vms != 'false'
        working-directory: elite
        run: |
          source action/ci-env.sh

          export VM_DEPLOYMENT="true"
          export VM_BRIDGE_IP="${{ steps.vms.outputs.bridge-ip }}"
          export VM_WORKER_IPS="${{ steps.vms.outputs.worker-ips }}"
          export VM_PROVIDER="${{ github.event.inputs.vm-provider || 'kvm' }}"

          action/ci-register-workers.sh

      - name: Display VM Information
        if: github.event.inputs.enable-vms != 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… VM INFRASTRUCTURE READY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Access:"
          echo "   â€¢ Bridge IP: ${{ steps.vms.outputs.bridge-ip }}"
          echo "   â€¢ Worker IPs: ${{ steps.vms.outputs.worker-ips }}"
          echo "   â€¢ API URL: http://localhost"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # Test setup and execution
      - name: Restore E2E Setup
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: e2e-setup-${{ github.run_id }}

      - name: Create Test Environment
        working-directory: elite
        run: |
          source action/ci-env.sh

          cd $GITHUB_WORKSPACE
          cp .env.sample .env

          sed -i "s|^BASE_URL=.*|BASE_URL=http://localhost|" .env
          sed -i "s|^TEST_USER_EMAIL=.*|TEST_USER_EMAIL=${SYSTEM_ADMIN_EMAIL}|" .env
          sed -i "s|^TEST_USER_PASSWORD=.*|TEST_USER_PASSWORD=${SYSTEM_ADMIN_PASSWORD}|" .env
          sed -i "s|^SYSTEM_ADMIN_EMAIL=.*|SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL}|" .env
          sed -i "s|^SYSTEM_ADMIN_PASSWORD=.*|SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD}|" .env
          sed -i "s|^CI=.*|CI=true|" .env
          sed -i "s|^API_TIMEOUT=.*|API_TIMEOUT=10000|" .env
          sed -i "s|^PAGE_TIMEOUT=.*|PAGE_TIMEOUT=30000|" .env
          sed -i "s|^BROWSER=.*|BROWSER=${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}|" .env

          echo "Created .env with Elite credentials"
          grep -v PASSWORD .env

      - name: Display Test Status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ RUNNING E2E TESTS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“ Configuration:"
          echo "   â€¢ VMs Enabled: ${{ github.event.inputs.enable-vms || env.DEFAULT_ENABLE_VMS }}"
          echo "   â€¢ Bridge IP: ${{ steps.vms.outputs.bridge-ip || 'N/A' }}"
          echo "   â€¢ Worker IPs: ${{ steps.vms.outputs.worker-ips || 'N/A' }}"
          echo "   â€¢ API URL: http://localhost"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Wait for Elite Services
        run: |
          echo "Waiting for Elite services to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost/health 2>/dev/null; do echo "Waiting for services..."; sleep 5; done' || {
            echo "Elite services health check failed, but continuing with tests..."
          }

      - name: Run Playwright Tests
        id: tests
        run: |
          BROWSER="${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"

          if [ "$BROWSER" = "all" ]; then
            npx playwright test
          else
            npx playwright test --project="$BROWSER"
          fi
        env:
          CI: true
          VM_WORKER_IPS: ${{ steps.vms.outputs.worker-ips }}
          VM_USR: ${{ steps.vms.outputs.machine-user }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-${{ github.run_id }}
          path: test-results/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ TEST SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          if [ -n "${{ github.event.inputs.source-repo }}" ]; then
            echo "ğŸ”— Source:"
            echo "   â€¢ Repository: ${{ github.event.inputs.source-repo }}"
            echo "   â€¢ Commit: ${{ github.event.inputs.source-commit }}"
            echo "   â€¢ Commit URL: https://github.com/${{ github.event.inputs.source-repo }}/commit/${{ github.event.inputs.source-commit }}"
            echo ""
          fi
          echo "ğŸ”— Test run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“Š Report artifact: playwright-report-${{ github.run_id }}"
          echo "â±ï¸  Completed at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Cleanup Elite Services
        if: always()
        working-directory: elite
        run: |
          echo "Cleaning up Elite services..."
          ./go down || true
          echo "âœ… Services stopped"
