name: E2E Tests

run-name: "${{ github.event.inputs.run-name || 'E2E Test Run' }}"

on:
  workflow_dispatch:
    inputs:
      run-name:
        description: 'Custom name for this test run'
        required: false
        default: 'E2E Test Run'
        type: string
      version:
        description: 'Elite version to test against'
        required: false
        default: 'latest'
        type: string
      browser:
        description: 'Browser to run tests in'
        required: false
        default: 'chromium'
        type: choice
        options:
          - 'chromium'
          - 'firefox'
          - 'webkit'
          - 'all'
      enable-vms:
        description: 'Enable VM provisioning'
        required: false
        default: true
        type: boolean
      vm-provider:
        description: 'VM infrastructure provider'
        required: false
        default: 'kvm'
        type: choice
        options:
          - 'kvm'
          - 'linode'
          - 'vultr'
      vm-configuration:
        description: 'VM cluster configuration'
        required: false
        default: 'Standard'
        type: choice
        options:
          - 'Minimal'
          - 'Basic'
          - 'Standard'
          - 'Full'
      vm-os-image:
        description: 'VM OS image'
        required: false
        default: 'rediacc-ubuntu-24.04'
        type: choice
        options:
          - 'ubuntu-24.04'
          - 'debian-12'
          - 'rediacc-ubuntu-24.04'
          - 'rediacc-debian-12'

  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  schedule:
    - cron: '0 6 * * *'

env:
  DEFAULT_VERSION: 'latest'
  DEFAULT_BROWSER: 'chromium'
  DEFAULT_ENABLE_VMS: 'true'
  DEFAULT_VM_PROVIDER: 'kvm'
  DEFAULT_VM_CONFIGURATION: 'Standard'
  DEFAULT_VM_OS_IMAGE: 'rediacc-ubuntu-24.04'

jobs:
  # Job 1: Provision VMs (runs in parallel with e2e-setup)
  vm-provisioning:
    name: Provision VMs
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event.inputs.enable-vms != 'false'

    outputs:
      bridge-ip: ${{ steps.vms.outputs.bridge-ip }}
      worker-ips: ${{ steps.vms.outputs.worker-ips }}
      machine-user: ${{ steps.vms.outputs.machine-user }}
      machine-password: ${{ steps.vms.outputs.machine-password }}
      api-url: ${{ steps.services.outputs.api-url }}

    steps:
      - name: Display VM Configuration
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ๏ธ  VM PROVISIONING CONFIGURATION"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Settings:"
          echo "   โข Provider: ${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}"
          echo "   โข Configuration: ${{ github.event.inputs.vm-configuration || env.DEFAULT_VM_CONFIGURATION }}"
          echo "   โข OS Image: ${{ github.event.inputs.vm-os-image || env.DEFAULT_VM_OS_IMAGE }}"
          echo "   โข Version: ${{ github.event.inputs.version || env.DEFAULT_VERSION }}"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Checkout Elite Repository
        uses: actions/checkout@v4
        with:
          repository: rediacc/elite
          token: ${{ secrets.GH_PAT }}

      - name: Validate Elite Version
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: ./action/ci-validate-version.sh "${{ github.event.inputs.version || env.DEFAULT_VERSION }}"

      - name: Pull Docker Images
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          TAG: ${{ env.TAG }}
        run: ./action/ci-pull-images.sh

      - name: Start Elite Services
        id: services
        uses: ./action
        with:
          keep-alive: true
          ci-mode: true
        env:
          TAG: ${{ env.TAG }}
          SKIP_MACHINE_REGISTRATION: 'true'

      - name: Extract SSH Keys
        env:
          TAG: ${{ env.TAG }}
        run: |
          echo "Extracting SSH keys from middleware..."

          timeout 60 bash -c 'until ./go health; do sleep 2; done'

          TAG_VERSION="${TAG:-latest}"
          if [ "$TAG_VERSION" = "latest" ]; then
            pip install --quiet rediacc
          else
            pip install --quiet "rediacc==$TAG_VERSION" 2>/dev/null || pip install --quiet rediacc
          fi

          source action/ci-env.sh
          export SYSTEM_API_URL="http://localhost/api"

          rediacc auth login \
            --endpoint "$SYSTEM_API_URL" \
            --email "$SYSTEM_ADMIN_EMAIL" \
            --password "$SYSTEM_ADMIN_PASSWORD"

          TEAM_VAULT=$(rediacc GetCompanyTeams --output json | \
            jq -r --arg team "$SYSTEM_DEFAULT_TEAM_NAME" \
            '.data.result[] | select(.teamName == $team or .TeamName == $team) | .vaultContent')

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "$TEAM_VAULT" | jq -r '.SSH_PRIVATE_KEY' | base64 -d > ~/.ssh/id_rsa
          echo "$TEAM_VAULT" | jq -r '.SSH_PUBLIC_KEY' | base64 -d > ~/.ssh/id_rsa.pub

          chmod 600 ~/.ssh/id_rsa
          chmod 644 ~/.ssh/id_rsa.pub

          echo "โ SSH keys extracted"
          rediacc auth logout

      - name: Provision VMs
        id: vms
        uses: rediacc/ops/.github/actions/setup-vms@main
        with:
          provider: ${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}
          configuration: ${{ github.event.inputs.vm-configuration || env.DEFAULT_VM_CONFIGURATION }}
          duration: '60'
          api-token: ${{ github.event.inputs.vm-provider == 'linode' && secrets.LINODE_API_TOKEN || github.event.inputs.vm-provider == 'vultr' && secrets.VULTR_API_TOKEN || '' }}
        env:
          VM_OS_IMAGE: ${{ github.event.inputs.vm-os-image || env.DEFAULT_VM_OS_IMAGE }}
          TAG: ${{ env.TAG }}
          DOCKER_BRIDGE_IMAGE: ghcr.io/rediacc/elite/bridge:${{ env.TAG }}
          DOCKER_BRIDGE_NETWORK_MODE: host
          DOCKER_BRIDGE_API_URL: http://localhost
          SYSTEM_API_URL: http://localhost/api
          SKIP_MACHINE_REGISTRATION: 'true'
          CI_MODE: 'true'

      - name: Register Worker Machines
        run: |
          source action/ci-env.sh

          export VM_DEPLOYMENT="true"
          export VM_BRIDGE_IP="${{ steps.vms.outputs.bridge-ip }}"
          export VM_WORKER_IPS="${{ steps.vms.outputs.worker-ips }}"
          export VM_PROVIDER="${{ github.event.inputs.vm-provider || 'kvm' }}"

          action/ci-register-workers.sh

      - name: Display VM Information
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ VM INFRASTRUCTURE READY"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Access:"
          echo "   โข Bridge IP: ${{ steps.vms.outputs.bridge-ip }}"
          echo "   โข Worker IPs: ${{ steps.vms.outputs.worker-ips }}"
          echo "   โข API URL: http://localhost"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

  # Job 2: Setup E2E environment (runs in parallel with vm-provisioning)
  e2e-setup:
    name: Setup E2E
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Display Configuration
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ง E2E TEST CONFIGURATION"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Run Details:"
          echo "   โข Run Name: ${{ github.event.inputs.run-name || 'E2E Test Run' }}"
          echo "   โข Trigger: ${{ github.event_name }}"
          echo "   โข Run ID: ${{ github.run_id }}"
          echo ""
          echo "โ๏ธ  Settings:"
          echo "   โข Version: ${{ github.event.inputs.version || env.DEFAULT_VERSION }}"
          echo "   โข Browser: ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"
          echo "   โข Enable VMs: ${{ github.event.inputs.enable-vms || env.DEFAULT_ENABLE_VMS }}"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Checkout E2E Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps ${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}

      - name: Cache E2E Setup
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: e2e-setup-${{ github.run_id }}

  # Job 3: Run E2E Tests (waits for both vm-provisioning and e2e-setup)
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [vm-provisioning, e2e-setup]
    if: always() && needs.e2e-setup.result == 'success'

    steps:
      - name: Checkout E2E Repository
        uses: actions/checkout@v4

      - name: Checkout Elite Repository
        uses: actions/checkout@v4
        with:
          repository: rediacc/elite
          path: elite
          token: ${{ secrets.GH_PAT }}

      - name: Restore E2E Setup
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: e2e-setup-${{ github.run_id }}

      - name: Create Test Environment
        working-directory: elite
        run: |
          source action/ci-env.sh

          cd $GITHUB_WORKSPACE
          cp .env.sample .env

          sed -i "s|^BASE_URL=.*|BASE_URL=http://localhost|" .env
          sed -i "s|^TEST_USER_EMAIL=.*|TEST_USER_EMAIL=${SYSTEM_ADMIN_EMAIL}|" .env
          sed -i "s|^TEST_USER_PASSWORD=.*|TEST_USER_PASSWORD=${SYSTEM_ADMIN_PASSWORD}|" .env
          sed -i "s|^SYSTEM_ADMIN_EMAIL=.*|SYSTEM_ADMIN_EMAIL=${SYSTEM_ADMIN_EMAIL}|" .env
          sed -i "s|^SYSTEM_ADMIN_PASSWORD=.*|SYSTEM_ADMIN_PASSWORD=${SYSTEM_ADMIN_PASSWORD}|" .env
          sed -i "s|^CI=.*|CI=true|" .env
          sed -i "s|^API_TIMEOUT=.*|API_TIMEOUT=10000|" .env
          sed -i "s|^PAGE_TIMEOUT=.*|PAGE_TIMEOUT=30000|" .env

          echo "Created .env with Elite credentials"
          grep -v PASSWORD .env

      - name: Display Test Status
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ RUNNING E2E TESTS"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Configuration:"
          echo "   โข VM Provisioning: ${{ needs.vm-provisioning.result || 'skipped' }}"
          echo "   โข Bridge IP: ${{ needs.vm-provisioning.outputs.bridge-ip || 'N/A' }}"
          echo "   โข API URL: http://localhost"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: Run Playwright Tests
        id: tests
        run: |
          BROWSER="${{ github.event.inputs.browser || env.DEFAULT_BROWSER }}"

          if [ "$BROWSER" = "all" ]; then
            npx playwright test
          else
            npx playwright test --project="$BROWSER"
          fi
        env:
          CI: true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: playwright-report/
          retention-days: 7

      - name: Upload Test Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-${{ github.run_id }}
          path: test-results/
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ TEST SUMMARY"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Test run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "๐ Report artifact: playwright-report-${{ github.run_id }}"
          echo "โฑ๏ธ  Completed at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

  # Job 4: Cleanup (always runs)
  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: [vm-provisioning, e2e-tests]
    if: always()

    steps:
      - name: Checkout SDK Repository
        if: needs.vm-provisioning.result == 'success'
        uses: actions/checkout@v4
        with:
          repository: rediacc/ops
          ref: main

      - name: Cleanup VMs
        if: needs.vm-provisioning.result == 'success'
        uses: ./.github/actions/cleanup-vms
        with:
          provider: ${{ github.event.inputs.vm-provider || env.DEFAULT_VM_PROVIDER }}

      - name: Cleanup Summary
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐งน CLEANUP COMPLETE"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "Job Results:"
          echo "   โข VM Provisioning: ${{ needs.vm-provisioning.result || 'skipped' }}"
          echo "   โข E2E Tests: ${{ needs.e2e-tests.result }}"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
